"use strict";let o,t,s=3e5,r=Date.now(),l,n,a,i,c=new URL(import.meta.url).origin,m=e=>document.getElementById(e),d=e=>window.localStorage.getItem(o.storePrefix+e),y=(e,t)=>window.localStorage.setItem(o.storePrefix+e,t),u=e=>window.localStorage.removeItem(o.storePrefix+e),p=window.localStorage.getItem("theme")||"colorful",f=window.localStorage.getItem("mode")||"dark",g="true"==window.localStorage.getItem("blind"),h="false"!=window.localStorage.getItem("animation"),D={green:"ðŸŸ©",orange:"ðŸŸ§",red:"ðŸŸ¥"},A={green:"ðŸ’š",orange:"ðŸŸ ",red:"ðŸŸ¥"};var e=window.matchMedia("(prefers-color-scheme: dark)");let b=e.matches,U=!1;var v=!1,w=0,k=[];let P=1e4;var L=0;let J=["DodgerBlue","OliveDrab","Gold","Pink","SlateBlue","LightBlue","Violet","PaleGreen","SteelBlue","SandyBrown","Chocolate","Crimson"];var q=()=>b&&"system"==f||"dark"==f;import{initializeApp as B}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";import{getAnalytics as G}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";import{getDatabase as W,set as x,update as V,increment as _,ref as C,push as F,off as K,onValue as R,onChildAdded as M,onChildChanged as T,goOnline as Q,goOffline as X}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";import{getAuth as Y,TwitterAuthProvider as Z,signInWithPopup as ee,onAuthStateChanged as te}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";function E(e){var t=JSON.parse(d("days"))||{};return t[e]||null}function N(e,t){var s=JSON.parse(d("days"))||{};s[e]=t,y("days",JSON.stringify(s))}function se(){m("error").innerHTML="Le temps imparti de 24h sâ€™est Ã©coulÃ©.<br />RafraÃ®chissement en cours...",setInterval(function(){window.location.reload()},3e3)}function ne(){document.querySelectorAll(".dialog-content").forEach(e=>e.style.display="none"),document.body.classList.remove("dialog-open"),m("guess").focus()}function ae(e){e.preventDefault(),o.inputIdx<o.input.length-1&&(o.inputIdx++,m("guess").value=o.input[o.inputIdx]),o.inputIdx>=o.input.length-1&&(m("previous").style.visibility="hidden"),m("guess").focus()}async function ie(e){e.preventDefault(),m("guess").focus();let t=m("guess").value.replace(/[^-\p{L}\p{N}]/gu,"");if(0!=t.length){t=t.toLowerCase(),o.input[0]=t,o.input.unshift(""),o.input=o.input.slice(0,21),o.inputIdx=0,m("ad").style.display="none",m("previous").style.visibility="visible",m("guess").value="",m("guess").placeholder=t,m("guess-btn").disabled=!0,m("error").textContent="";try{var s=document.getElementsByClassName("google-revocation-link-placeholder");0<s.length&&!U&&(s[0].children[0].children[0].children[3].dispatchEvent(new Event("click")),U=!0)}catch(e){}if(o.guesses.hasOwnProperty(t))m("guess-btn").disabled=!1,o.showGuess(t,o.guesses[t][1],!0);else{s=await o.getScore(t);if(m("guess-btn").disabled=!1,!s)return!(m("error").innerHTML="Une erreur sÂ´est produite.");if(s.r)se();else if(s.e)m("error").innerHTML=s.e;else{if(o.solversRef?o.ranking=o.solvers+1:(o.ranking=s.v,H(s.v),r=Date.now()),re(t,s.w,s.score),await o.showGuess(s.w,s.score,!0),!o.secret){var[n,,]=o.getSecret(t,s,s.score);if(n){if(o.secret=n,N(o.puzzleNumber,o.nTries),y("turns",JSON.stringify(o.getTurns())),y("secret",JSON.stringify(o.secret)),y("ranking",o.ranking),H(o.ranking),o.solversRef)try{V(o.rootRef,{[o.puzzleNumber]:_(1)})}catch(e){}if(o.syncRef)try{R(o.syncRef,e=>ye(e),{onlyOnce:!0})}catch(e){}oe();try{if(h){var a=document.createElement("canvas");function i(){a.width=document.documentElement.clientWidth,a.height=document.documentElement.clientHeight,w=a.width/2}a.setAttribute("id","confetti-canvas"),document.body.appendChild(a),i(),window.addEventListener("resize",function(){i()},!0);for(var d=a.getContext("2d");k.length<w;)k.push(Le({},a.width,a.height));v=!0;var u=null;requestAnimationFrame(function e(t){if(null==u?u=t:t-u>P&&(v=!1),d.clearRect(0,0,document.documentElement.clientWidth,document.documentElement.clientHeight),0<k.length){var s=document.documentElement.clientWidth,n=document.documentElement.clientHeight;L+=.01;for(var a=0;a<k.length;a++){var i=k[a];!v&&i.y<-15?i.y=n+100:(i.tiltAngle+=i.tiltAngleIncrement,i.x+=Math.sin(L),i.y+=.5*(Math.cos(L)+i.diameter+2),i.tilt=15*Math.sin(i.tiltAngle)),(i.x>s+20||i.x<-20||i.y>n)&&(v&&k.length<=w?Le(i,s,n):(k.splice(a,1),a--))}for(var r=d,o=0;o<k.length;o++){var l=k[o],c=(r.beginPath(),r.lineWidth=l.diameter,r.strokeStyle=l.color,l.x+l.tilt);r.moveTo(c+l.diameter/2,l.y),r.lineTo(c,l.y+l.tilt+l.diameter/2),r.stroke()}requestAnimationFrame(e)}})}}catch(e){}}}o.teamRef&&o.isCloudable(s.score)&&x(C(l,j(o.teamRef.key,t)),s.score)}}}return!1}function S(t){var e,s,n;"_users"==t.key?o.teamTwitter||(o.teamMembers=t.val(),m("team-members").textContent=o.teamMembers):o.guesses.hasOwnProperty(t.key)||(e=t.val(),[s,n]=o.getSecret(t.key,e,e),m("ad").style.display="none",s&&!o.secret?(m("error").innerHTML=n,m("secret").style.display="block",m("reveal").addEventListener("click",e=>{m("guess").value=t.key,m("guess").focus()})):(re(t.key,t.key,e),o.showGuess(t.key,e,!1),m("guess").placeholder=t.key))}function re(e,t,s){o.guessCount++,o.guesses[e]=[o.guessCount,s],e!=t&&(o.guesses[t]=[o.guessCount,s]),y("guesses",JSON.stringify(o.guesses)),o.secret||(o.nTries++,N(o.puzzleNumber,-o.nTries))}function oe(){let e;e=3<o.ranking?o.ranking+"<sup>e</sup>":3==o.ranking?"ðŸ¥‰3<sup>e</sup>":2==o.ranking?"ðŸ¥ˆ2<sup>e</sup>":1==o.ranking?"ðŸ¥‡1<sup>er</sup>":"N<sup>Ã¨me</sup>",m("tries").textContent=o.nTries+" coup"+(1<o.nTries?"s":""),m("ranking").innerHTML=e,m("meter").innerHTML=o.showStory(JSON.parse(d("turns"))||[],"<br />"),m("solution").innerHTML=o.showSecret(!1,o.secret),m("secret").style.display="none",m("success").style.opacity=1,m("success").style.maxHeight="100%",m("success").style.marginBottom=".25em"}async function z(){if(!(Date.now()-r<s)){r=Date.now();try{var e=await(await fetch("/stats?n="+o.puzzleNumber)).json();e.r?se():H(e.v)}catch(e){}}}function H(e){var t=m("solved");t.textContent&&e<o.solvers||(o.solvers=e,t.textContent="TrouvÃ© par ",1<e?t.textContent+=e+" personnes":1==e?t.textContent+="1 personne":0==e?t.textContent+="personne":t.textContent="")}function le(){n!=l&&Q(n),R(o.solversRef,e=>{(!e.exists()||(H(e.val()),e.val()>=o.maxLiveSolvers))&&I()},e=>{I()})}function ce(){o.solversRef&&K(o.solversRef),n!=l&&X(n)}function I(){ce(),o.solversRef=null,y("live",!1),H(o.solvers),z(),t=t||setInterval(z,s)}async function de(){return new Promise((t,s)=>{let n=new Z;a.useDeviceLanguage(),te(a,e=>{e?t(e.providerData[0]):ee(a,n).then(e=>{t(e.user.providerData[0])}).catch(e=>s(e))})})}async function ue(){document.body.classList.add("dialog-open"),m("cloud").style.display="block";try{var e=await fetch(c+"/html/cemantix-cloud.html");m("cloudbody").innerHTML=await e.text(),m("start").addEventListener("click",e=>async function(){m("start").disabled=!0,m("join").disabled=!0,m("signin").disabled=!0;try{o.teamRef=F(C(l,j())),o.teamCode=o.teamRef.key.replace(/-/gu,"Ã”"),me(),M(o.teamRef,e=>S(e)),T(o.teamRef,e=>S(e)),x(C(l,j(o.teamRef.key,"_users")),1),m("team-status").innerHTML=`Veuillez partager le code <b class="teamcode">${o.teamCode}</b> avec votre Ã©quipe.`;try{await navigator.clipboard.writeText(o.teamCode),m("team-error").textContent="Code copiÃ© dans le presse-papiers"}catch(e){}m("cloud-button").textContent="thunderstorm",m("code").value=o.teamCode,m("twitter-collab").style.display="none"}catch(e){m("team-error").textContent="Une erreur sÂ´est produite. "+e,m("start").disabled=!1,m("join").disabled=!1,m("signin").disabled=!1}}()),m("join").addEventListener("click",e=>async function(){if(o.teamCode=m("code").value.trim(),!o.teamCode)return!(m("team-error").textContent="Veuillez entrer un code");m("start").disabled=!0,m("join").disabled=!0,m("signin").disabled=!0;try{o.teamRef=C(l,j(o.teamCode.replace(/Ã”/gu,"-"))),R(o.teamRef,e=>{e.exists()?(me(e),M(o.teamRef,e=>S(e)),T(o.teamRef,e=>S(e)),e.forEach(e=>{"_users"==e.key&&x(C(l,j(o.teamRef.key,"_users")),e.val()+1)}),m("team-status").innerHTML=`Vous avez rejoint lÂ´Ã©quipe <b class="teamcode">${o.teamCode}</b>.`,m("cloud-button").textContent="thunderstorm",m("twitter-collab").style.display="none"):(m("team-error").textContent="Code non valide.",o.teamRef=null,m("start").disabled=!1,m("join").disabled=!1,m("signin").disabled=!1)},{onlyOnce:!0})}catch(e){m("team-error").textContent="Code non valide. "+e,o.teamRef=null,m("start").disabled=!1,m("join").disabled=!1,m("signin").disabled=!1}}()),m("leave").addEventListener("click",e=>$()),m("signin").addEventListener("click",e=>async function(){m("start").disabled=!0,m("join").disabled=!0,m("signin").disabled=!0;try{i=i||await de(),o.teamRef=C(l,j(i.uid)),o.teamTwitter=!0,R(o.teamRef,e=>{me(e),M(o.teamRef,e=>S(e)),T(o.teamRef,e=>S(e))},{onlyOnce:!0}),o.syncRef=C(l,O(i.uid)),R(o.syncRef,e=>ye(e),{onlyOnce:!0}),m("twitter-name").textContent=i.displayName,m("twitter-photo").src=i.photoURL,m("twitter-status").innerHTML=`Vous Ãªtes identifiÃ© comme <img class="twitter-button" src='${i.photoURL}' />&nbsp;<b>${i.displayName}</b>`,m("join-twitter").style.display="none",m("team-collab").style.display="none",m("cloud-button").textContent="thunderstorm"}catch(e){m("start").disabled=!1,m("join").disabled=!1,m("signin").disabled=!1}}()),m("signout").addEventListener("click",e=>$()),m("team-status").textContent="",m("team-error").textContent="",m("twitter-status").textContent="",o.teamRef?(m("start-team").style.display="none",m("join-team").style.display="none",m("join-twitter").style.display="none",m("start").disabled=!0,m("join").disabled=!0,m("signin").disabled=!0,o.teamTwitter?m("leave-twitter").style.display="block":(m("leave-twitter").style.display="none",m("twitter-collab").style.display="none",m("leave-team").style.display="block",m("team").textContent=o.teamCode)):$()}catch(e){m("cloudbody").innerHTML="Une erreur sÂ´est produite."}m("dialog-close").focus()}function j(e="",t=""){return t?"g/"+o.puzzleNumber+"/"+e+"/"+t:e?"g/"+o.puzzleNumber+"/"+e:"g/"+o.puzzleNumber}function O(e,t=""){return t?"stats/"+e+"/"+t:"stats/"+e}async function me(e){var t,s,n;for([t,[s,n]]of Object.entries(o.guesses).sort((e,t)=>e[1][0]-t[1][0]))!o.isCloudable(n)||e&&e.hasChild(t)||x(C(l,j(o.teamRef.key,t)),n)}function $(){m("leave").disabled=!0,m("signout").disabled=!0,o.teamRef&&(K(o.teamRef),o.teamTwitter||(1==o.teamMembers?(x(C(l,j(o.teamRef.key)),null),o.teamCode=""):x(C(l,j(o.teamRef.key,"_users")),o.teamMembers-1)),o.teamRef=null,o.teamTwitter=!1),m("start").disabled=!1,m("join").disabled=!1,m("leave").disabled=!1,m("signin").disabled=!1,m("signout").disabled=!1,m("team-collab").style.display="block",m("twitter-collab").style.display="block",m("start-team").style.display="block",m("join-team").style.display="block",m("join-twitter").style.display="block",m("leave-team").style.display="none",m("leave-twitter").style.display="none",m("team-status").textContent="",m("team-error").textContent="",m("twitter-status").textContent="",m("cloud-button").textContent="cloud",m("team-members").textContent="",m("code").value="",o.teamMembers=""}async function ye(e){for(let i=1;i<=o.puzzleNumber;i++){var t,s=i.toString(),n=e?e.child(s).val():null,a=E(i);n!=a&&((t=(0<n||0<a?1:-1)*Math.max(Math.abs(n),Math.abs(a)))!=a&&(N(i,t),i==o.puzzleNumber)&&(o.guessCount=Math.abs(t),o.nTries=o.guessCount),t!=n)&&x(C(l,O(o.syncRef.key,s)),t)}y("sync",Date.now()),ge(await fe())}async function pe(){m("sync").disabled=!0,m("refresh").disabled=!0;try{i=i||await de(),o.syncRef=C(l,O(i.uid)),R(o.syncRef,e=>ye(e),{onlyOnce:!0}),m("sync-name").textContent=i.displayName,m("sync-photo").src=i.photoURL,m("sync-twitter").style.display="none",m("sync-time").textContent="maintenant",m("refresh").style.display="none",m("history-sync").style.display="block",m("synced-twitter").style.display="block"}catch(e){m("sync").disabled=!1,m("refresh").disabled=!1}}async function fe(){if(0<o.cacheHistory.length)return o.cacheHistory;try{return await(await fetch("/history")).json()}catch(e){return null}}function ge(s){let n="";for(var[a,i,r]of s){let e=E(a),t="";e?0<e?t="âœ…":(e=-e,a<o.puzzleNumber&&(t="âŒ")):e="",a==o.puzzleNumber&&(i=o.solvers,o.cacheHistory=s),n+=`<tr>
<td class="number">${a}</td>
<td class="word"><b>${o.showSecret(!0,r)}</b></td>
<td class="number">${e}</td>
<td>${t}</td>
<td class="number">${0<i?i:""}</td>
</tr>`}m("historytable").innerHTML=n}async function he(){document.body.classList.add("dialog-open"),m("history").style.display="block";try{var e=await fetch(`${c}/html/${o.appName}-history.html`),t=(m("historybody").innerHTML=await e.text(),m("sync").addEventListener("click",e=>pe()),m("refresh").addEventListener("click",e=>pe()),await fe());if(!t)return!(m("error").innerHTML="Une erreur sÂ´est produite.");document.body.classList.add("dialog-open"),i?(m("sync-name").textContent=i.displayName,m("sync-photo").src=i.photoURL,m("sync-twitter").style.display="none",m("synced-twitter").style.display="block",m("refresh").style.display="inline-block"):(m("sync-twitter").style.display="block",m("synced-twitter").style.display="none",m("refresh").style.display="none"),d("sync")?(m("sync-time").textContent="il y a "+(s=d("sync"),n=Math.floor((Date.now()-s)/1e3),(a=Math.floor(n/86400))?a+" jour"+(1<a?"s":""):(n%=86400,(a=Math.floor(n/3600))?a+" heure"+(1<a?"s":""):(n%=3600,(a=Math.floor(n/60))?a+" minute"+(1<a?"s":""):(n%=60)?n+" seconde"+(1<n?"s":""):"un moment"))),m("history-sync").style.display="block"):m("history-sync").style.display="none",ge(t)}catch(e){m("historybody").innerHTML="Une erreur sÂ´est produite."}var s,n,a;m("dialog-close").focus()}async function be(){let e=["colorful","grey"],t=["light","dark","system"];document.body.classList.add("dialog-open"),m("theme").style.display="block";try{var s,n,a=await fetch(c+"/html/cemantix-theme.html");function i(e,t,s){e.target.checked?(window.localStorage.setItem(t,s),p=window.localStorage.getItem("theme")||"colorful","system"==(f=window.localStorage.getItem("mode")||"dark")?document.documentElement.className=(b?"dark":"light")+"-"+p:document.documentElement.className=f+"-"+p,o.showGuesses()):e.preventDefault()}m("themebody").innerHTML=await a.text(),m("blind").checked=g,m("animation").checked=h,m("colorful").addEventListener("click",e=>i(e,"theme","colorful")),m("grey").addEventListener("click",e=>i(e,"theme","grey")),m("light").addEventListener("click",e=>i(e,"mode","light")),m("dark").addEventListener("click",e=>i(e,"mode","dark")),m("system").addEventListener("click",e=>i(e,"mode","system")),m("blind").addEventListener("click",e=>{g=e.target.checked,o.blocks=g?A:D,window.localStorage.setItem("blind",g)}),m("animation").addEventListener("click",e=>{h=e.target.checked,window.localStorage.setItem("animation",h)});for(s of e)m(s).checked=s==p;for(n of t)m(n).checked=n==f}catch(e){m("themebody").innerHTML="Une erreur sÂ´est produite."}m("dialog-close").focus()}async function ve(){document.body.classList.add("dialog-open"),m("rules").style.display="block";try{var e=await fetch(`${c}/html/${o.appName}-rules.html`),t=new Date;t.setTime(1e3*o.utcTime),m("rulesbody").innerHTML=await e.text(),m("localtime").textContent=t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}),y("readRules",!0)}catch(e){m("rulesbody").innerHTML="Une erreur sÂ´est produite."}m("dialog-close").focus()}async function we(){document.body.classList.add("dialog-open"),m("faq").style.display="block";try{var e=await fetch(c+"/html/cemantix-faq.html");m("faqbody").innerHTML=await e.text()}catch(e){m("faqbody").innerHTML="Une erreur sÂ´est produite."}m("dialog-close").focus()}async function ke(){document.body.classList.add("dialog-open"),m("story").style.display="block";var e=Math.abs(E(o.puzzleNumber)),t=o.showStory(JSON.parse(d("turns"))||[],"\n"),e=`J'ai trouvÃ© #${o.appName} nÂº${o.puzzleNumber} en ${e} coup${1<e?"s":""} !
${t}
${o.url} `;m("share-story").innerHTML=e.replace(/\n/gu,"<br />");try{await navigator.clipboard.writeText(e),m("clipboard").innerHTML="CopiÃ© dans le presse-papiers"}catch(e){m("clipboard").innerHTML="Erreur de copiage dans le presse-papiers<br />"+e}m("dialog-close").focus()}function Le(e,t,s){return e.color=J[Math.random()*J.length|0],e.x=Math.random()*t,e.y=Math.random()*s-s,e.diameter=10*Math.random()+5,e.tilt=10*Math.random()-10,e.tiltAngleIncrement=.07*Math.random()+.05,e.tiltAngle=0,e}function xe(e,t){e.preventDefault(),o.appName!=t&&window.location.replace(`https://${t}.certitudes.org`)}async function Ce(){o.initPage(),o.puzzleNumber!=d("puzzleNumber")&&(u("secret"),u("ranking"),u("turns"),u("guesses"),u("live"),y("puzzleNumber",o.puzzleNumber));var e=E(o.puzzleNumber);if(e&&(o.nTries=Math.abs(e),o.guesses=JSON.parse(d("guesses"))||{},o.guessCount=o.showGuesses(),o.secret=JSON.parse(d("secret")),o.secret)&&(o.ranking=d("ranking"),oe()),m("share").addEventListener("click",ke),m("form").addEventListener("submit",e=>ie(e)),m("previous").addEventListener("click",ae),m("guess").addEventListener("keydown",e=>{switch(e.key){case"ArrowUp":ae(e);break;case"ArrowDown":e.preventDefault(),0<o.inputIdx&&(o.inputIdx--,m("guess").value=o.input[o.inputIdx]),o.inputIdx<o.input.length-1&&(m("previous").style.visibility="visible"),m("guess").focus()}}),m("day-meter").innerHTML=o.showStory(o.getTurns(),"",10),m("guess-btn").disabled=!1,m("guess").focus(),e||(m("ad").classList.add("adsbygoogle"),m("ad").style.display="block",(window.adsbygoogle||[]).push({})),o.solvers=function(){for(var e of document.cookie.split("; ")){var[e,t]=e.split("=");if("v"===e)return document.cookie="v=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/",t}if("true"==d("live"))return 0;r=0}(),o.solvers<o.maxLiveSolvers)try{y("live",!0),o.rootRef=C(n),o.solversRef=C(n,""+o.puzzleNumber),le()}catch(e){I()}else I();d("readRules")||ve();let t=document.querySelector("section");new MutationObserver(()=>{t.style.minHeight="100vh"}).observe(t,{attributes:!0,attributeFilter:["style"]})}async function Re(e){(o=e).storePrefix=o.prefix?o.prefix+"/":"",o.blocks=g?A:D,o.guesses={},o.secret="",o.guessCount=0,o.nTries=0,o.ranking=0,o.cacheHistory=[],o.input=[""],o.inputIdx=0,o.solvers=0,o.teamRef=null,o.teamCode="",o.teamMembers="",o.teamTwitter=!1,o.syncRef=null,async function(){var e=B(o.firebaseConfig);l=W(e),a=Y(),G(e),n=o.firebaseSolversConfig?(e=B(o.firebaseSolversConfig,"solvers"),W(e)):l}(),Ce()}b&&"system"==f?document.documentElement.className=(b?"dark":"light")+"-"+p:document.documentElement.className=f+"-"+p,e.onchange=e=>{b=!!e.matches,"system"==f&&(document.documentElement.className=(b?"dark":"light")+"-"+p,o.showGuesses())};let Me={init:async function(){m("rules-button").addEventListener("click",ve),m("faq-button").addEventListener("click",we),m("theme-button").addEventListener("click",be),m("history-button").addEventListener("click",e=>he()),m("cloud-button").addEventListener("click",ue),m("dialog-underlay").addEventListener("click",ne),m("dialog-close").addEventListener("click",ne),m("dialog").addEventListener("click",e=>e.stopPropagation()),m("cemantix").addEventListener("click",e=>xe(e,"cemantix")),m("pedantix").addEventListener("click",e=>xe(e,"pedantix")),document.addEventListener("visibilitychange",e=>{"visible"==document.visibilityState?o.solversRef?le():t||(t=setInterval(z,s),z()):o.solversRef?ce():(clearInterval(t),t=null)}),window.addEventListener("beforeunload",e=>{m("see").checked=!1,o.teamRef&&$()}),"serviceWorker"in navigator&&navigator.serviceWorker.register("/worker.js").catch(()=>{})}};window.addEventListener("load",async()=>Me.init());export{q as darkMode,Re as initGame};